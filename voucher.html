<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Voucher</title>

  <!-- Favicon đồng bộ theo theme -->
  <link id="favicon" rel="icon" type="image/svg+xml" href="assets/favicon-light.svg"/>

  <!-- Tailwind cho layout nhanh -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ===== THEME (copy từ redeem) ===== -->
  <style>
    :root{
      --bg:#0b1020; --bg-soft:#11162a; --card:#121a33; --text:#e7ecf7; --muted:#a8b2d1;
      --primary:#7aa2ff; --primary-strong:#5a86ff; --ok:#22c55e; --err:#ef4444;
      --border:rgba(255,255,255,.08); --shadow:0 10px 30px rgba(0,0,0,.25);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f8fa; --bg-soft:#eef1f6; --card:#ffffff; --text:#111827; --muted:#6b7280;
        --primary:#2563eb; --primary-strong:#1e40af; --ok:#16a34a; --err:#dc2626;
        --border:rgba(0,0,0,.08); --shadow:0 10px 30px rgba(0,0,0,.08);
      }
    }
    :root[data-theme="light"]{
      --bg:#f6f8fa; --bg-soft:#eef1f6; --card:#fff; --text:#111827; --muted:#6b7280;
      --primary:#2563eb; --primary-strong:#1e40af; --ok:#16a34a; --err:#dc2626;
      --border:rgba(0,0,0,.08); --shadow:0 10px 30px rgba(0,0,0,.08);
    }
    :root[data-theme="dark"]{
      --bg:#0b1020; --bg-soft:#11162a; --card:#121a33; --text:#e7ecf7; --muted:#a8b2d1;
      --primary:#7aa2ff; --primary-strong:#5a86ff; --ok:#22c55e; --err:#ef4444;
      --border:rgba(255,255,255,.08); --shadow:0 10px 30px rgba(0,0,0,.25);
    }

    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Inter, Roboto, Arial;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(122,162,255,.18), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(125,211,252,.16), transparent 60%),
        var(--bg);
    }

    .wrap{ max-width:1100px; margin:0 auto; padding:20px 16px 40px; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom: 16px; }
    .title{ display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px; }
    .logo{ width:36px; height:36px; border-radius:12px; display:grid; place-items:center;
           background: linear-gradient(135deg, var(--primary), #60a5fa); box-shadow: var(--shadow); }
    .icon{ width:18px; height:18px; object-fit:contain; display:inline-block; }
    .muted{ color:var(--muted); font-size:14px; }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; }
    .btn{ border:none; cursor:pointer; background: var(--primary); color:white; font-weight:700;
          padding:10px 14px; border-radius:12px; text-decoration:none; display:inline-flex; align-items:center; gap:8px; }
    .btn:hover{ background: var(--primary-strong); }
    .btn.secondary{ background: transparent; color: var(--text); border:1px solid var(--border); }
    .btn.secondary:hover{ background: var(--bg-soft); }

    .card{ background: var(--card); border:1px solid var(--border); border-radius:18px; box-shadow: var(--shadow); }
    .badge{ border:1px solid var(--border); border-radius:999px; padding:4px 10px; font-size:12px; color:var(--muted); background: var(--bg-soft) }
    .status.active{color:var(--ok)} .status.expired{color:var(--err)} .status.used{color:#f59e0b}
    .big{font-size:28px;font-weight:800} .mono{font-family:ui-monospace,monospace}

    .qr-card{ border:1px solid var(--border); border-radius:16px; background: var(--bg-soft); box-shadow: var(--shadow); }
    .qr-note{ border-top:1px dashed var(--border); padding:10px 12px; font-size:12px; color:var(--muted); background: var(--card); }

    .toast{ position:fixed; top:16px; right:16px; max-width:320px; z-index:60;
      background:var(--card); color:var(--text); border:1px solid var(--border); border-left:4px solid var(--primary);
      border-radius:12px; padding:12px 14px; box-shadow:var(--shadow);
      opacity:0; transform: translateY(-6px); transition: all .25s ease; pointer-events:none; }
    .toast.show{ opacity:1; transform:none; pointer-events:auto; }
    .toast.success{ border-left-color:#22c55e } .toast.error{ border-left-color:#ef4444 } .toast.info{ border-left-color:var(--primary) }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- ===== Header giống redeem, KHÔNG dùng logo.png ===== -->
    <div class="topbar">
      <div class="title">
        <div class="logo"><img src="assets/gift.svg" class="icon" alt="gift"></div>
        <div>
          <div>Voucher</div>
          <div class="muted" id="statusSub">Quét & xác thực mã</div>
        </div>
      </div>
      <div class="actions">
        <a class="btn secondary" href="library.html"><img src="assets/book.svg" class="icon" alt=""> Thư viện</a>
        <a class="btn secondary" href="redeem.html"><img src="assets/gift.svg" class="icon" alt=""> Đổi quà</a>
        <button id="themeBtn" class="btn secondary" title="Đổi giao diện">
          <img id="themeIcon" class="icon" alt="theme">
        </button>
      </div>
    </div>

    <!-- ===== Main ===== -->
    <main>
      <section class="card p-6">
        <div class="flex justify-between items-center">
          <h1 class="big">Chi tiết voucher</h1>
          <span id="statusBadge" class="badge status">Đang tải...</span>
        </div>

        <div class="grid md:grid-cols-2 gap-6 mt-4">
          <!-- LEFT -->
          <div>
            <div class="flex justify-between"><span class="muted">Món quà</span><strong id="giftName">—</strong></div>
            <div class="flex justify-between"><span class="muted">Mã voucher</span><span id="voucherId" class="mono">—</span></div>
            <div class="flex justify-between"><span class="muted">Ngày cấp</span><span id="issuedAt">—</span></div>
            <div class="flex justify-between"><span class="muted">Hạn dùng</span><span id="expiresAt">—</span></div>
            <div class="flex justify-between"><span class="muted">Còn lại</span><span id="remaining">—</span></div>

            <div class="mt-6 flex flex-wrap gap-3">
              <button id="backBtn" class="btn secondary">Quay lại đổi quà</button>
              <button id="useBtn" class="btn">Đánh dấu đã dùng</button>
            </div>
          </div>

          <!-- RIGHT: QR -->
          <div class="qr-card p-4">
            <div class="text-center">
              <div class="muted mb-2">Mã QR</div>
              <div id="qrcode" class="inline-block p-3 border rounded-lg" style="background:var(--card)"></div>
            </div>
            <div class="qr-note mt-4">
              Dùng app đối tác để quét & xác thực. Nhân viên có thể nhập mã thủ công nếu cần.
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"><strong id="toast-title"></strong><div id="toast-msg"></div></div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <!-- QRCode.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- ===== ThemeManager v2.1 (lưu prefs.theme vào Firestore) ===== -->
  <script>
  (function ThemeManager_v21(){
    const LS_KEY = 'voucher-theme';
    const root = document.documentElement;
    let currentTheme = null;

    const getSystemPref = () =>
      (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) ? 'light' : 'dark';

    function applyTheme(t){
      currentTheme = t;
      if (t) root.setAttribute('data-theme', t); else root.removeAttribute('data-theme');
      try { window.dispatchEvent(new CustomEvent('themechange',{ detail:{ theme:t } })); } catch {}
    }
    function saveLocal(t){ try{ t?localStorage.setItem(LS_KEY,t):localStorage.removeItem(LS_KEY); }catch{} }

    // init theo local/system
    (function initFirst(){
      const ls = localStorage.getItem(LS_KEY);
      applyTheme(ls || getSystemPref());
    })();

    // bind nút toggle
    function bindToggle(){
      const b = document.getElementById('themeBtn');
      if (!b || b.__tmBound) return;
      b.__tmBound = true;
      b.addEventListener('click', ()=> window.ThemeManager?.toggle());
    }
    bindToggle(); new MutationObserver(bindToggle).observe(document.documentElement,{childList:true,subtree:true});

    window.ThemeManager = {
      getTheme(){ return currentTheme || root.getAttribute('data-theme') || getSystemPref(); },
      async setTheme(t){
        if (t!=='light' && t!=='dark') return;
        applyTheme(t); saveLocal(t);
        // lưu Firestore nếu đã đăng nhập
        try{
          const u = firebase.auth().currentUser;
          if (u){
            await firebase.firestore().collection('users').doc(u.uid).set({
              prefs:{ theme:t, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }
            }, { merge:true });
          }
        }catch(e){ console.warn('save theme fail', e); }
      },
      async toggle(){ const next = (this.getTheme()==='dark' ? 'light' : 'dark'); await this.setTheme(next); }
    };
  })();
  </script>

  <!-- Đồng bộ icon & re-render QR khi đổi theme -->
  <script>
    const faviconEl = document.getElementById('favicon');
    const themeIcon = document.getElementById('themeIcon');
    function applyThemeAssets(mode){
      if (themeIcon){
        themeIcon.src = mode==='dark' ? 'assets/theme-dark.svg' : 'assets/theme-light.svg';
        themeIcon.alt = mode==='dark' ? 'Dark' : 'Light';
      }
      if (faviconEl){
        faviconEl.href = mode==='dark' ? 'assets/favicon-dark.svg' : 'assets/favicon-light.svg';
        const bust='?v='+Date.now(); faviconEl.href=faviconEl.href.split('?')[0]+bust;
      }
      if (window.__lastVoucherId) renderQRCode(window.__lastVoucherId);
    }
    (function initIconOnce(){
      const mode = (window.ThemeManager?.getTheme && window.ThemeManager.getTheme()) || 'dark';
      applyThemeAssets(mode);
    })();
    window.addEventListener('themechange', e=>{
      const mode = e?.detail?.theme || 'dark';
      applyThemeAssets(mode);
    });
  </script>

  <!-- ===== App logic: nhận diện voucher chắc chắn + lưu Firestore ===== -->
  <script>
    // Firebase init (idempotent)
    const firebaseConfig = {
      apiKey: "AIzaSyDOhTKHU4P3jJ7aTkvSiewNoHu1_KXkcrU",
      authDomain: "loginandsignin-4932b.firebaseapp.com",
      projectId: "loginandsignin-4932b",
      storageBucket: "loginandsignin-4932b.appspot.com",
      messagingSenderId: "863133586719",
      appId: "1:863133586719:web:81eb32db8e08e8d89e8c2a"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // UI helpers
    const $ = (id)=> document.getElementById(id);
    const giftNameEl = $('giftName');
    const voucherIdEl= $('voucherId');
    const issuedAtEl = $('issuedAt');
    const expiresAtEl= $('expiresAt');
    const remainingEl= $('remaining');
    const statusBadge= $('statusBadge');
    const backBtn    = $('backBtn');
    const useBtn     = $('useBtn');

    backBtn.onclick = ()=> history.length>1 ? history.back() : location.href='redeem.html';

    function setStatusBadge(status){
      statusBadge.className = 'badge status ' + (status || 'active');
      statusBadge.textContent = status || 'active';
    }
    function showToast(title, msg, type='info', after=null){
      const t  = $('toast'), tt = $('toast-title'), tm = $('toast-msg');
      t.className = 'toast '+type; tt.textContent = title; tm.textContent = msg;
      requestAnimationFrame(()=> t.classList.add('show'));
      setTimeout(()=>{ t.classList.remove('show'); if(after) after(); }, 2600);
    }

    // Nhận ID từ URL -> sanitize
    function getIdFromURL(){
      const qs = new URLSearchParams(location.search);
      let raw = qs.get('id') || qs.get('voucher_id') || qs.get('vid') || null;
      if (!raw) return null;
      try { raw = decodeURIComponent(raw).trim(); } catch {}
      return raw || null;
    }
    function sanitizeId(id){
      if (!id) return null;
      const ok = /^[A-Za-z0-9_\-]+$/.test(id);
      return ok ? id : null;
    }

    // Đọc/ghi last_voucher_id trên Firestore
    async function getUserLastVoucherId(uid){
      try{
        const u = await db.collection('users').doc(uid).get();
        return u.exists ? (u.data().last_voucher_id || null) : null;
      }catch{ return null; }
    }
    async function saveUserLastVoucher(uid, vId){
      try{
        await db.collection('users').doc(uid).set({
          last_voucher_id: vId,
          last_seen_voucher_at: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
      }catch(e){ console.warn('[voucher] save last_voucher_id fail:', e); }
    }

    // Thử cả 'vouchers' và 'voucher'
    async function loadVoucherDocFlexible(vId){
      const paths = ['vouchers', 'voucher'];
      for (const col of paths){
        const snap = await db.collection(col).doc(vId).get();
        if (snap.exists) return { col, data: snap.data() };
      }
      return null;
    }

    // Bổ sung trường & đồng bộ trạng thái
    async function ensureExpiresField(vId, col, data){
      if (data.expiresAt) return data;
      const validDays = Number(data.validDays || 7);
      const issuedMs = data.issuedAt?.toDate ? data.issuedAt.toDate().getTime()
                    : (typeof data.issuedAt === 'number' ? data.issuedAt : Date.now());
      const expMs = issuedMs + validDays*24*60*60*1000;
      const expiresAt = firebase.firestore.Timestamp.fromDate(new Date(expMs));
      await db.collection(col).doc(vId).set({ expiresAt }, { merge: true });
      return { ...data, expiresAt };
    }
    async function ensureStatusUpToDate(vId, col, data){
      const exp = data.expiresAt?.toDate ? data.expiresAt.toDate().getTime()
                 : (typeof data.expiresAt === 'number' ? data.expiresAt : null);
      if (!exp) return data;
      if (Date.now() > exp && (data.status || 'active') === 'active'){
        await db.collection(col).doc(vId).set({ status: 'expired' }, { merge:true });
        return { ...data, status:'expired' };
      }
      return data;
    }

    // QR & countdown
    function renderQRCode(voucherCode){
      const qrEl = $('qrcode'); if (!qrEl) return;
      qrEl.innerHTML = '';
      const cs = getComputedStyle(document.documentElement);
      new QRCode(qrEl,{
        text: voucherCode, width:180, height:180,
        colorDark: cs.getPropertyValue('--text').trim() || '#000',
        colorLight:cs.getPropertyValue('--card').trim() || '#fff',
        correctLevel: QRCode.CorrectLevel.H
      });
    }
    let timer=null;
    function startCountdown(expireMs){
      function tick(){
        let diff = expireMs - Date.now();
        if (diff <= 0){ remainingEl.textContent = 'Đã hết hạn'; clearInterval(timer); timer=null; return; }
        const d=Math.floor(diff/86400000); diff%=86400000;
        const h=Math.floor(diff/3600000);  diff%=3600000;
        const m=Math.floor(diff/60000);    diff%=60000;
        const s=Math.floor(diff/1000);
        remainingEl.textContent = `${d} ngày ${h} giờ ${m} phút ${s} giây`;
      }
      tick(); timer=setInterval(tick,1000);
    }

    // MAIN
    auth.onAuthStateChanged(async user=>{
      if(!user){
        showToast('Cần đăng nhập','Chuyển tới đăng nhập...','info', ()=> location.href='login.html');
        return;
      }
      try{
        // 1) Lấy ID ưu tiên URL, sau đó Firestore (không dùng localStorage)
        const raw = getIdFromURL();
        const idFromURL = sanitizeId(raw);
        let vId = idFromURL;

        if (!vId){
          if (raw){
            showToast('ID không hợp lệ','ID chỉ gồm A-Z, a-z, 0-9, _ hoặc -','error');
            console.warn('[voucher] Raw ID from URL chứa ký tự lạ:', raw);
            return;
          }
          vId = await getUserLastVoucherId(user.uid);
        }

        if (!vId){
          voucherIdEl.textContent = '—';
          setStatusBadge('error');
          showToast('Thiếu ID','Không thấy ?id=... và users.last_voucher_id trống.','error');
          console.warn('[voucher] Missing id: URL & Firestore both empty');
          return;
        }

        // 2) Lưu lại users/{uid}.last_voucher_id để đồng bộ thiết bị
        await saveUserLastVoucher(user.uid, vId);

        // 3) Tải doc (thử 'vouchers' rồi 'voucher')
        const pack = await loadVoucherDocFlexible(vId);
        if (!pack){
          voucherIdEl.textContent = vId;
          setStatusBadge('error');
          showToast('Không tìm thấy','Không có doc tại collections "vouchers" hoặc "voucher".','error');
          console.warn('[voucher] Not found in both collections. ID:', vId);
          return;
        }
        let { col, data } = pack;

        // 4) Bổ sung expiresAt + cập nhật status nếu hết hạn
        data = await ensureExpiresField(vId, col, data);
        data = await ensureStatusUpToDate(vId, col, data);

        // 5) Render
        window.__lastVoucherId = vId;
        voucherIdEl.textContent = vId;
        giftNameEl.textContent  = data.giftName || '—';

        const issued  = data.issuedAt?.toDate ? data.issuedAt.toDate()
                       : (typeof data.issuedAt === 'number' ? new Date(data.issuedAt) : null);
        const expires = data.expiresAt?.toDate ? data.expiresAt.toDate()
                       : (typeof data.expiresAt === 'number' ? new Date(data.expiresAt) : null);

        issuedAtEl.textContent  = issued  ? issued.toLocaleString('vi-VN') : '—';
        expiresAtEl.textContent = expires ? expires.toLocaleString('vi-VN') : '—';
        setStatusBadge(data.status || 'active');

        renderQRCode(vId);
        if (expires) startCountdown(expires.getTime()); else remainingEl.textContent = '—';

        showToast('OK','Voucher đã sẵn sàng.','success');

        // 6) Đánh dấu đã dùng
        useBtn.onclick = async ()=>{
          try{
            await db.collection(col).doc(vId).set({ status:'used' }, { merge:true });
            setStatusBadge('used');
            showToast('Thành công','Đã đánh dấu voucher là ĐÃ DÙNG.','success');
            await db.collection('users').doc(user.uid).set({
              last_used_voucher_id: vId,
              last_used_at: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge:true });
          }catch(e){
            showToast('Lỗi','Không thể cập nhật trạng thái: '+e.message,'error');
          }
        };
      }catch(e){
        console.error(e);
        showToast('Lỗi tải', e.message || 'Không thể tải voucher.','error');
      }
    });
  </script>
</body>
</html>
