<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Voucher của bạn</title>

  <!-- Favicon SVG theo theme -->
  <link id="favicon" rel="icon" type="image/svg+xml" href="assets/favicon-light.svg" />

  <!-- Firebase v8 (giữ nguyên SDK theo bản gốc) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <!-- qrcodejs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    /* ========= THEME ========= */
    :root{
      --bg:#0b1020; --bg-soft:#11162a; --card:#121a33; --text:#e7ecf7; --muted:#a8b2d1;
      --primary:#7aa2ff; --primary-strong:#5a86ff; --ok:#22c55e; --err:#ef4444;
      --border:rgba(255,255,255,.08); --shadow:0 10px 30px rgba(0,0,0,.25);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f8fa; --bg-soft:#eef1f6; --card:#ffffff; --text:#111827; --muted:#6b7280;
        --primary:#2563eb; --primary-strong:#1e40af; --ok:#16a34a; --err:#dc2626;
        --border:rgba(0,0,0,.08); --shadow:0 10px 30px rgba(0,0,0,.08);
      }
    }
    :root[data-theme="light"]{ --bg:#f6f8fa; --bg-soft:#eef1f6; --card:#ffffff; --text:#111827; --muted:#6b7280; --primary:#2563eb; --primary-strong:#1e40af; --ok:#16a34a; --err:#dc2626; --border:rgba(0,0,0,.08); --shadow:0 10px 30px rgba(0,0,0,.08); }
    :root[data-theme="dark"]{ --bg:#0b1020; --bg-soft:#11162a; --card:#121a33; --text:#e7ecf7; --muted:#a8b2d1; --primary:#7aa2ff; --primary-strong:#5a86ff; --ok:#22c55e; --err:#ef4444; --border:rgba(255,255,255,.08); --shadow:0 10px 30px rgba(0,0,0,.25); }

    /* ========= LAYOUT ========= */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(122,162,255,.18), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(125,211,252,.16), transparent 60%),
        var(--bg);
    }
    .wrap{ max-width: 920px; margin: 0 auto; padding: 28px 20px 56px; }

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom: 20px;
    }
    .title{ display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px; }
    .logo{
      width:36px; height:36px; border-radius:12px; display:grid; place-items:center;
      background: linear-gradient(135deg, var(--primary), #60a5fa);
      box-shadow: var(--shadow);
    }
    .icon{width:18px;height:18px;object-fit:contain;display:inline-block}
    .actions{ display:flex; gap:10px; flex-wrap:wrap }

    .btn{
      appearance:none; border:none; cursor:pointer;
      background: var(--primary);
      color:white; font-weight:700;
      padding:10px 14px; border-radius:12px;
      transition: transform .12s ease, background .2s ease;
      box-shadow: 0 6px 18px rgba(37,99,235,.25);
      text-decoration:none; display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{ transform: translateY(-1px); background: var(--primary-strong); }
    .btn.secondary{
      background: transparent; color: var(--text); border:1px solid var(--border);
      box-shadow:none;
    }
    .btn.secondary:hover{ background: var(--bg-soft); }

    .theme-toggle{
      border:1px solid var(--border); background: var(--card);
      color:var(--text); border-radius: 12px; padding:8px 12px; cursor:pointer;
    }

    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 22px;
    }

    .hero{
      display:grid; grid-template-columns: 1.1fr .9fr; gap:16px;
    }
    @media (max-width: 820px){ .hero{ grid-template-columns: 1fr; } }

    .status{ font-size:14px; color:var(--muted); margin: 4px 0 16px; }
    .status .ok{ color: var(--ok); }
    .status .err{ color: var(--err); font-weight:600; }

    .voucher-details p{ margin: 8px 0; }
    .meta{ color: var(--muted); font-size: 14px; }

    /* ========= QR CONTAINER (Căn giữa tuyệt đối) ========= */
    #qrcode{
      width: 240px;
      height: 240px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 8px auto;
      padding: 10px;
      background: var(--bg-soft);
      border: 1px dashed var(--border);
      border-radius: 16px;
    }
    #qrcode img, #qrcode canvas{ max-width:100%; height:auto; display:block; }

    /* ========= Skeleton ========= */
    .skeleton{
      border-radius: 12px; background: linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.12), rgba(255,255,255,.06));
      height: 16px; animation: pulse 1.2s ease-in-out infinite;
    }
    @keyframes pulse { 0%{opacity:.6} 50%{opacity:1} 100%{opacity:.6} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <div class="logo">
          <img src="assets/voucher.svg" class="icon" alt="voucher">
        </div>
        <div>
          <div>Voucher</div>
          <div class="status" id="status">Đang kiểm tra...</div>
        </div>
      </div>
      <div class="actions">
        <a class="btn secondary" href="library.html">
          <img src="assets/book.svg" class="icon" alt="library"> Thư viện
        </a>
        <button class="theme-toggle" id="themeBtn" aria-label="Đổi giao diện">
          <img id="themeIcon" src="assets/theme-light.svg" class="icon" alt="theme">
        </button>
      </div>
    </div>

    <div class="hero">
      <div class="card voucher-details">
        <h2 style="margin-top:0">Chi tiết voucher</h2>
        <div class="skeleton" id="sk1"></div>
        <div class="skeleton" id="sk2" style="width:60%; margin-top:8px"></div>

        <div id="content" style="display:none">
          <p><strong>Quà:</strong> <span id="giftName">—</span></p>
          <p><strong>Hết hạn:</strong> <span id="expiry">—</span></p>
          <p class="meta" id="ownerInfo"></p>
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px">
            <a class="btn secondary" href="redeem.html">
              <img src="assets/back.svg" class="icon" alt="back"> Quay lại
            </a>
            <a class="btn" href="library.html">
              <img src="assets/book.svg" class="icon" alt="library"> Xem Thư viện
            </a>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">Mã QR</h3>
        <div id="qrcode" aria-label="QR voucher"></div>
        <p class="meta">Quét QR tại quầy để kiểm tra và sử dụng.</p>
      </div>
    </div>
  </div>

  <script>
    // ===== Firebase config (giữ nguyên như bản gốc) =====
    const firebaseConfig = {
      apiKey: "AIzaSyDOhTKHU4P3jJ7aTkvSiewNoHu1_KXkcrU",
      authDomain: "loginandsignin-4932b.firebaseapp.com",
      projectId: "loginandsignin-4932b",
      storageBucket: "loginandsignin-4932b.appspot.com",
      messagingSenderId: "863133586719",
      appId: "1:863133586719:web:81eb32db8e08e8d89e8c2a"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
  </script>

  <!-- ===== ThemeManager: đồng bộ theme LocalStorage <-> user (nếu có) ===== -->
  <script>
  (function ThemeManagerInit(){
    const LS_KEY = 'voucher-theme';
    const root = document.documentElement;
    let currentTheme = null;

    const getSystemPref = () =>
      (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) ? 'light' : 'dark';

    function dispatchChange(theme){ try{window.dispatchEvent(new CustomEvent('themechange',{detail:{theme}}))}catch{} }
    function applyTheme(theme){ currentTheme = theme; theme ? root.setAttribute('data-theme', theme) : root.removeAttribute('data-theme'); dispatchChange(theme); }
    function saveToLocal(theme){ theme ? localStorage.setItem(LS_KEY, theme) : localStorage.removeItem(LS_KEY); }

    // Áp sớm theo LS/system
    (function(){ const fromLS = localStorage.getItem(LS_KEY); applyTheme(fromLS || getSystemPref()); })();

    // Toggle
    document.getElementById('themeBtn')?.addEventListener('click', ()=>{
      const cur = root.getAttribute('data-theme') || getSystemPref();
      const next = (cur === 'dark') ? 'light' : 'dark';
      applyTheme(next); saveToLocal(next);
      if (firebase?.auth?.().currentUser) {
        firebase.firestore().collection('users').doc(firebase.auth().currentUser.uid)
          .set({ prefs:{ theme: next, updatedAt: firebase.firestore.FieldValue.serverTimestamp() } }, { merge:true });
      }
    });

    // Nếu login -> ưu tiên theme từ cloud
    firebase.auth().onAuthStateChanged(async user=>{
      if (!user) return;
      try{
        const snap = await firebase.firestore().collection('users').doc(user.uid).get();
        const cloud = snap.exists && snap.data()?.prefs?.theme;
        if (cloud==='light'||cloud==='dark'){ applyTheme(cloud); saveToLocal(cloud); }
      }catch{}
    });

    // Đồng bộ favicon + icon theo theme
    function applyAssets(mode){
      const tIcon = document.getElementById('themeIcon');
      if (tIcon) tIcon.src = mode==='dark' ? 'assets/theme-dark.svg' : 'assets/theme-light.svg';
      const fav=document.getElementById('favicon');
      if (fav){
        fav.href = mode==='dark' ? 'assets/favicon-dark.svg' : 'assets/favicon-light.svg';
        fav.href = fav.href.split('?')[0] + '?v=' + Date.now();
      }
    }
    applyAssets(currentTheme || getSystemPref());
    window.addEventListener('themechange', e=> applyAssets(e.detail.theme));
  })();
  </script>

  <!-- ===== Business Logic: tải voucher & render QR ===== -->
  <script>
    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    const statusEl = document.getElementById('status');
    const contentEl = document.getElementById('content');
    const giftNameEl = document.getElementById('giftName');
    const expiryEl = document.getElementById('expiry');
    const qrcodeContainer = document.getElementById('qrcode');
    const ownerInfoEl = document.getElementById('ownerInfo');
    const sk1 = document.getElementById('sk1');
    const sk2 = document.getElementById('sk2');

    const docId = getQueryParam('id');
    if (!docId) {
      statusEl.innerHTML = '<span class="err">Lỗi: không có ID voucher trong URL.</span>';
      sk1.style.display = sk2.style.display = 'none';
      throw new Error('Missing voucher id');
    }

    auth.onAuthStateChanged(async user => {
      if (!user) {
        statusEl.innerHTML = 'Bạn phải <a class="btn secondary" href="login.html">đăng nhập</a> để xem voucher.';
        sk1.style.display = sk2.style.display = 'none';
        return;
      }

      statusEl.textContent = 'Đang tải voucher...';

      try {
        // Ưu tiên collection vouchers, nếu không có thì thử redeem_logs
        let docSnap = null;
        try { docSnap = await db.collection('vouchers').doc(docId).get(); }
        catch(e){ docSnap = null; }

        if (!docSnap || !docSnap.exists) {
          docSnap = await db.collection('redeem_logs').doc(docId).get();
        }

        if (!docSnap.exists) {
          statusEl.innerHTML = '<span class="err">Voucher không tồn tại hoặc đã bị xóa.</span>';
          sk1.style.display = sk2.style.display = 'none';
          return;
        }

        const data = docSnap.data();

        // Chặn xem nếu có uid và khác chủ sở hữu
        if (data.uid && data.uid !== user.uid) {
          statusEl.innerHTML = '<span class="err">Bạn không có quyền xem voucher này.</span>';
          sk1.style.display = sk2.style.display = 'none';
          return;
        }

        // Hiển thị
        contentEl.style.display = 'block';
        statusEl.innerHTML = '<span class="ok">Đã tải xong.</span>';
        setTimeout(()=>statusEl.textContent='', 1200);
        sk1.style.display = sk2.style.display = 'none';

        const giftName = data.giftName || data.gift || 'Không rõ';
        giftNameEl.innerText = giftName;

        // Tính hạn: ưu tiên expiry; nếu không có dùng redeemedAt/createdAt +7 ngày
        let expiryDate = null;
        if (data.expiry) {
          expiryDate = (typeof data.expiry.toDate === 'function') ? data.expiry.toDate() : new Date(data.expiry);
        } else if (data.redeemedAt) {
          expiryDate = (typeof data.redeemedAt.toDate === 'function') ? data.redeemedAt.toDate() : new Date(data.redeemedAt);
          expiryDate.setDate(expiryDate.getDate() + 7);
        } else if (data.createdAt) {
          expiryDate = (typeof data.createdAt.toDate === 'function') ? data.createdAt.toDate() : new Date(data.createdAt);
          expiryDate.setDate(expiryDate.getDate() + 7);
        }
        expiryEl.innerText = expiryDate ? expiryDate.toLocaleString('vi-VN') : 'Không có thông tin hạn';

        if (data.uid) ownerInfoEl.innerText = `Id chủ voucher: ${data.uid}`;

        // Tạo QR — encode "voucher:<id>"
        const qrText = `voucher:${docId}`;
        qrcodeContainer.innerHTML = '';
        new QRCode(qrcodeContainer, { text: qrText, width: 220, height: 220 });

      } catch (err) {
        console.error('Lỗi tải voucher:', err);
        if (err && err.code === 'permission-denied') {
          statusEl.innerHTML = '<span class="err">Không có quyền truy cập voucher. Kiểm tra đăng nhập hoặc Firestore rules.</span>';
        } else {
          statusEl.innerHTML = `<span class="err">Lỗi tải voucher: ${err.message || err}</span>`;
        }
        sk1.style.display = sk2.style.display = 'none';
      }
    });
  </script>
</body>
</html>
