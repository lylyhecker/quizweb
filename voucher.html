<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Voucher</title>

  <!-- Favicon SVG (đổi bằng JS cho đồng bộ như redeem) -->
  <link id="favicon" rel="icon" type="image/svg+xml" href="assets/favicon-light.svg"/>

  <!-- Tailwind cho layout/spacing -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --bg:#0b1020; --bg-soft:#11162a; --card:#121a33; --text:#e7ecf7; --muted:#a8b2d1;
      --primary:#7aa2ff; --primary-strong:#5a86ff; --ok:#22c55e; --err:#ef4444;
      --border:rgba(255,255,255,.08); --shadow:0 10px 30px rgba(0,0,0,.25);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f8fa; --bg-soft:#eef1f6; --card:#ffffff; --text:#111827; --muted:#6b7280;
        --primary:#2563eb; --primary-strong:#1e40af; --ok:#16a34a; --err:#dc2626;
        --border:rgba(0,0,0,.08); --shadow:0 10px 30px rgba(0,0,0,.08);
      }
    }
    :root[data-theme="light"]{ --bg:#f6f8fa; --bg-soft:#eef1f6; --card:#fff; --text:#111827; --muted:#6b7280; --primary:#2563eb; --primary-strong:#1e40af; --ok:#16a34a; --err:#dc2626; --border:rgba(0,0,0,.08); --shadow:0 10px 30px rgba(0,0,0,.08); }
    :root[data-theme="dark"]{  --bg:#0b1020; --bg-soft:#11162a; --card:#121a33; --text:#e7ecf7; --muted:#a8b2d1; --primary:#7aa2ff; --primary-strong:#5a86ff; --ok:#22c55e; --err:#ef4444; --border:rgba(255,255,255,.08); --shadow:0 10px 30px rgba(0,0,0,.25); }

    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Inter, Roboto, Arial;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(122,162,255,.18), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(125,211,252,.16), transparent 60%),
        var(--bg);
    }
    header,footer{ background: var(--card); border-bottom:1px solid var(--border) }
    footer{ border-top:1px solid var(--border); border-bottom:none }
    .card{ background: var(--card); border:1px solid var(--border); border-radius:18px; box-shadow: var(--shadow); }
    .icon{ width:18px; height:18px; object-fit:contain }
    .btn{
      display:inline-flex; align-items:center; gap:8px;
      background: transparent; color: var(--text);
      border:1px solid var(--border); border-radius:12px;
      padding:8px 12px; cursor:pointer;
    }
    .btn:hover{ background: var(--bg-soft) }
    .btn.primary{ border:none; background: var(--primary); color:#fff; box-shadow: 0 6px 18px rgba(37,99,235,.25); }
    .btn.primary:hover{ background: var(--primary-strong) }
    .badge{ border:1px solid var(--border); border-radius:999px; padding:4px 10px; font-size:12px; color:var(--muted); background: var(--bg-soft) }
    .status.active{color:var(--ok)} .status.expired{color:var(--err)} .status.used{color:#f59e0b}
    .muted{color:var(--muted)} .big{font-size:28px;font-weight:800} .mono{font-family:ui-monospace,monospace}

    /* QR bên phải + ô bo góc */
    .qr-card{ border:1px solid var(--border); border-radius:16px; background: var(--bg-soft); box-shadow: var(--shadow); }
    .qr-note{ border-top:1px dashed var(--border); border-radius:0 0 16px 16px; padding:10px 12px; font-size:12px; color:var(--muted); background: var(--card); }

    /* Toast – không chặn click khi ẩn */
    .toast{ position:fixed; top:16px; right:16px; max-width:320px; z-index:60;
      background:var(--card); color:var(--text); border:1px solid var(--border); border-left:4px solid var(--primary);
      border-radius:12px; padding:12px 14px; box-shadow:var(--shadow);
      opacity:0; transform: translateY(-6px); transition: all .25s ease; pointer-events:none;
    }
    .toast.show{ opacity:1; transform:none; pointer-events:auto; }
    .toast.success{ border-left-color:#22c55e } .toast.error{ border-left-color:#ef4444 } .toast.info{ border-left-color:var(--primary) }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="shadow">
    <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center gap-2">
        <img src="assets/logo.png" class="w-9 h-9 rounded-lg object-cover" alt="logo">
        <strong>Voucher</strong>
      </div>
      <nav class="flex items-center gap-2">
        <a class="btn" href="library.html"><img src="assets/book.svg" class="icon" alt="">Thư viện</a>
        <a class="btn" href="redeem.html"><img src="assets/gift.svg" class="icon" alt="">Đổi quà</a>
        <button id="themeBtn" class="btn" title="Đổi giao diện">
          <img id="themeIcon" class="icon" alt="theme">
        </button>
      </nav>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-4 py-6">
    <section class="card p-6">
      <div class="flex justify-between items-center">
        <h1 class="big">Chi tiết voucher</h1>
        <span id="statusBadge" class="badge status">Đang tải...</span>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
        <!-- LEFT: Thông tin -->
        <div>
          <div class="flex justify-between"><span class="muted">Món quà</span><strong id="giftName">—</strong></div>
          <div class="flex justify-between"><span class="muted">Mã voucher</span><span id="voucherId" class="mono">—</span></div>
          <div class="flex justify-between"><span class="muted">Ngày cấp</span><span id="issuedAt">—</span></div>
          <div class="flex justify-between"><span class="muted">Hạn dùng</span><span id="expiresAt">—</span></div>
          <div class="flex justify-between"><span class="muted">Còn lại</span><span id="remaining">—</span></div>

          <div class="mt-6 flex flex-wrap gap-3">
            <button id="backBtn" class="btn">Quay lại đổi quà</button>
            <button id="useBtn" class="btn primary">Đánh dấu đã dùng</button>
          </div>
        </div>

        <!-- RIGHT: QR + ô bo góc -->
        <div class="qr-card p-4">
          <div class="text-center">
            <div class="muted mb-2">Mã QR</div>
            <div id="qrcode" class="inline-block p-3 border rounded-lg" style="background:var(--card); border-color:var(--border)"></div>
          </div>
          <div class="qr-note mt-4">
            Dùng app đối tác để quét & xác thực. Nhân viên có thể nhập mã thủ công nếu cần.
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="max-w-6xl mx-auto px-4 py-4 text-center text-sm muted">
      © 2025 Quiz & Assistant — Design by Mr.Hecker
    </div>
  </footer>

  <!-- Toast -->
  <div id="toast" class="toast"><strong id="toast-title"></strong><div id="toast-msg" class="mt-1 text-sm"></div></div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <!-- QRCode.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- Theme Manager (đầy đủ như redeem, có lưu LS + đổi favicon/icon + phát event) -->
  <script>
    (function(){
      const LS_KEY='voucher-theme', root=document.documentElement;
      let currentTheme=null;

      const getSystemPref = () =>
        (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) ? 'light' : 'dark';

      function applyTheme(t){ currentTheme=t; root.setAttribute('data-theme', t); }
      function saveToLocal(t){ localStorage.setItem(LS_KEY, t); }
      function dispatchChange(t){ try{ window.dispatchEvent(new CustomEvent('themechange',{detail:{theme:t}})); }catch{} }

      // asset theo theme (icon nút + favicon + QR)
      function applyAssets(mode){
        const icon = document.getElementById('themeIcon');
        if(icon){
          icon.src = mode==='dark' ? 'assets/theme-dark.svg' : 'assets/theme-light.svg';
          icon.alt = mode==='dark' ? 'Dark' : 'Light';
        }
        const fav = document.getElementById('favicon');
        if (fav){
          fav.href = mode==='dark' ? 'assets/favicon-dark.svg' : 'assets/favicon-light.svg';
          // bust cache để Chrome refresh ngay
          fav.href = fav.href.split('?')[0] + '?v=' + Date.now();
        }
        if (window.__lastVoucherId) renderQRCode(window.__lastVoucherId);
      }

      // khởi tạo
      (function init(){
        const ls = localStorage.getItem(LS_KEY);
        const first = ls || getSystemPref();
        applyTheme(first);
        applyAssets(first);
      })();

      // API giống redeem
      window.ThemeManager = {
        getTheme(){ return currentTheme || root.getAttribute('data-theme') || getSystemPref(); },
        setTheme(t){ if(t!=='light' && t!=='dark') return;
          applyTheme(t); saveToLocal(t); applyAssets(t); dispatchChange(t);
        },
        toggle(){ const cur=this.getTheme(); this.setTheme(cur==='dark'?'light':'dark'); }
      };

      // bind nút
      document.getElementById('themeBtn')?.addEventListener('click', ()=> {
        ThemeManager.toggle();
        const mode = ThemeManager.getTheme();
        showToast('Đã đổi giao diện', `Chế độ hiện tại: ${mode==='dark'?'Tối':'Sáng'}`, 'info');
      });

      // theo dõi system khi chưa chọn tay
      if (window.matchMedia){
        try {
          window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', ()=>{
            if (!localStorage.getItem(LS_KEY)) {
              ThemeManager.setTheme(getSystemPref());
            }
          });
        } catch(_) {}
      }
    })();
  </script>

  <!-- Toast helper -->
  <script>
    function showToast(title, msg, type='info', after=null){
      const t  = document.getElementById('toast');
      const tt = document.getElementById('toast-title');
      const tm = document.getElementById('toast-msg');
      t.className = 'toast '+type;
      tt.textContent = title; tm.textContent = msg;
      requestAnimationFrame(()=> t.classList.add('show'));
      setTimeout(()=>{ t.classList.remove('show'); if(after) after(); }, 2300);
    }
  </script>

  <!-- App logic -->
  <script>
    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyDOhTKHU4P3jJ7aTkvSiewNoHu1_KXkcrU",
      authDomain: "loginandsignin-4932b.firebaseapp.com",
      projectId: "loginandsignin-4932b",
      storageBucket: "loginandsignin-4932b.appspot.com",
      messagingSenderId: "863133586719",
      appId: "1:863133586719:web:81eb32db8e08e8d89e8c2a"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    const qs = new URLSearchParams(location.search);
    const idQ = qs.get('id');
    const $ = (id)=> document.getElementById(id);

    const giftNameEl = $('giftName');
    const voucherIdEl= $('voucherId');
    const issuedAtEl = $('issuedAt');
    const expiresAtEl= $('expiresAt');
    const remainingEl= $('remaining');
    const statusBadge= $('statusBadge');
    const backBtn    = $('backBtn');
    const useBtn     = $('useBtn');

    backBtn.onclick = ()=> history.length>1 ? history.back() : location.href='redeem.html';

    // Đếm ngược
    let timer=null;
    function startCountdown(expireMs){
      function tick(){
        const now=Date.now(); let diff=expireMs-now;
        if(diff<=0){ remainingEl.textContent='Đã hết hạn'; clearInterval(timer); timer=null; return; }
        const d=Math.floor(diff/86400000); diff%=86400000;
        const h=Math.floor(diff/3600000);  diff%=3600000;
        const m=Math.floor(diff/60000);    diff%=60000;
        const s=Math.floor(diff/1000);
        remainingEl.textContent=`${d} ngày ${h} giờ ${m} phút ${s} giây`;
      }
      tick(); timer=setInterval(tick,1000);
    }

    function setStatusBadge(status){
      statusBadge.className='badge status '+status;
      statusBadge.textContent=status;
    }

    async function loadVoucherDoc(uid){
      if (idQ){
        const doc = await db.collection('vouchers').doc(idQ).get();
        if (doc.exists) return { id:idQ, data:doc.data() };
      }
      const u = await db.collection('users').doc(uid).get();
      const vid = u.exists ? (u.data().last_voucher_id || null) : null;
      if (!vid) return null;
      const doc = await db.collection('vouchers').doc(vid).get();
      if (!doc.exists) return null;
      return { id:vid, data:doc.data() };
    }

    function renderQRCode(voucherCode){
      const qrEl = document.getElementById('qrcode');
      if (!qrEl) return;
      qrEl.innerHTML = '';
      const styles = getComputedStyle(document.documentElement);
      new QRCode(qrEl,{
        text:voucherCode, width:180, height:180,
        colorDark: styles.getPropertyValue('--text').trim() || '#000',
        colorLight:styles.getPropertyValue('--card').trim() || '#fff',
        correctLevel: QRCode.CorrectLevel.H
      });
    }

    useBtn.onclick = async ()=>{
      const id = idQ || voucherIdEl.textContent;
      if(!id) return;
      try{
        await db.collection('vouchers').doc(id).set({ status:'used' }, { merge:true });
        setStatusBadge('used');
        showToast('Thành công','Đã đánh dấu voucher là ĐÃ DÙNG.','success');
      }catch(e){
        showToast('Lỗi','Không thể cập nhật trạng thái: '+e.message,'error');
      }
    };

    auth.onAuthStateChanged(async user=>{
      if(!user){ showToast('Cần đăng nhập','Chuyển tới đăng nhập...','info',()=>location.href='login.html'); return; }
      try{
        const res = await loadVoucherDoc(user.uid);
        if(!res){ showToast('Không tìm thấy','Voucher không tồn tại hoặc đã xoá.','error'); return; }

        const { id, data } = res;
        const giftName = data.giftName || '—';
        const issued   = data.issuedAt?.toDate ? data.issuedAt.toDate() : null;
        const expires  = data.expiresAt?.toDate ? data.expiresAt.toDate() : null;
        const status   = data.status || 'active';

        giftNameEl.textContent = giftName;
        voucherIdEl.textContent= id;
        issuedAtEl.textContent = issued ? issued.toLocaleString('vi-VN') : '—';
        expiresAtEl.textContent= expires ? expires.toLocaleString('vi-VN') : '—';
        setStatusBadge(status);

        window.__lastVoucherId = id;
        renderQRCode(id);

        if (expires) startCountdown(expires.getTime());
        else remainingEl.textContent = '—';

        showToast('Tải thành công','Voucher đã sẵn sàng để quét.','success');
      }catch(e){
        console.error(e);
        showToast('Lỗi tải', e.message || 'Không thể tải voucher.','error');
      }
    });
  </script>
</body>
</html>
