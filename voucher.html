<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Voucher</title>

  <!-- Favicon (JS sẽ chuyển giữa light/dark) -->
  <link id="favicon" rel="icon" type="image/svg+xml" href="assets/favicon-light.svg"/>

  <!-- Tailwind (layout/spacing) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --bg:#0b1020; --bg-soft:#11162a; --card:#121a33; --text:#e7ecf7; --muted:#a8b2d1;
      --primary:#7aa2ff; --primary-strong:#5a86ff; --ok:#22c55e; --err:#ef4444;
      --border:rgba(255,255,255,.08); --shadow:0 10px 30px rgba(0,0,0,.25);
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f8fa; --bg-soft:#eef1f6; --card:#ffffff; --text:#111827; --muted:#6b7280; --primary:#2563eb; --primary-strong:#1e40af; --ok:#16a34a; --err:#dc2626; --border:rgba(0,0,0,.08); --shadow:0 10px 30px rgba(0,0,0,.08); }
    }
    :root[data-theme="light"]{ --bg:#f6f8fa; --bg-soft:#eef1f6; --card:#ffffff; --text:#111827; --muted:#6b7280; --primary:#2563eb; --primary-strong:#1e40af; --ok:#16a34a; --err:#dc2626; --border:rgba(0,0,0,.08); --shadow:0 10px 30px rgba(0,0,0,.08); }
    :root[data-theme="dark"]{ --bg:#0b1020; --bg-soft:#11162a; --card:#121a33; --text:#e7ecf7; --muted:#a8b2d1; --primary:#7aa2ff; --primary-strong:#5a86ff; --ok:#22c55e; --err:#ef4444; --border:rgba(255,255,255,.08); --shadow:0 10px 30px rgba(0,0,0,.25); }

    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Inter, Roboto, Arial;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(122,162,255,.18), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(125,211,252,.16), transparent 60%),
        var(--bg);
    }
    header,footer{ background: var(--card); border-bottom:1px solid var(--border) }
    footer{ border-top:1px solid var(--border); border-bottom:none }
    .card{ background: var(--card); border:1px solid var(--border); border-radius:18px; box-shadow: var(--shadow); }
    .icon{ width:18px; height:18px; object-fit:contain }
    .btn{
      display:inline-flex; align-items:center; gap:8px;
      background: transparent; color: var(--text);
      border:1px solid var(--border); border-radius:12px;
      padding:8px 12px; cursor:pointer;
    }
    .btn:hover{ background: var(--bg-soft) }
    .btn.primary{ border:none; background: var(--primary); color:#fff; box-shadow: 0 6px 18px rgba(37,99,235,.25); }
    .btn.primary:hover{ background: var(--primary-strong) }
    .badge{ border:1px solid var(--border); border-radius:999px; padding:4px 10px; font-size:12px; color:var(--muted); background: var(--bg-soft) }

    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .status{font-weight:800}
    .status.active{color:var(--ok)}
    .status.expired{color:var(--err)}
    .status.used{color:#f59e0b}
    .muted{color:var(--muted)}
    .big{font-size:28px;font-weight:800}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

    /* Khối QR phải: ô chữ nhật bo góc bên dưới QR */
    .qr-card{
      border:1px solid var(--border);
      border-radius:16px;
      background: var(--bg-soft);
      box-shadow: var(--shadow);
    }
    .qr-note{
      border-top:1px dashed var(--border);
      border-radius:0 0 16px 16px;
      padding:10px 12px;
      font-size:12px;
      color:var(--muted);
      background: var(--card);
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="shadow">
    <div class="max-w-6xl mx-auto px-4 py-3 row">
      <div class="row" style="gap:10px">
        <img src="assets/logo.png" class="w-9 h-9 rounded-lg object-cover" alt="logo">
        <strong>Voucher</strong>
      </div>
      <nav class="row" style="gap:8px">
        <a class="btn" href="library.html"><img src="assets/book.svg" class="icon" alt="">Thư viện</a>
        <a class="btn" href="redeem.html"><img src="assets/gift.svg" class="icon" alt="">Đổi quà</a>
        <button id="themeBtn" class="btn" title="Đổi giao diện">
          <img id="themeIcon" class="icon" alt="theme">
        </button>
      </nav>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-4 py-6">
    <section class="card p-6">
      <div class="row">
        <h1 class="big">Chi tiết voucher</h1>
        <span id="statusBadge" class="badge status">Đang tải...</span>
      </div>

      <!-- Lưới 2 cột: trái = info; phải = QR + ô bo góc -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
        <!-- LEFT: Thông tin -->
        <div>
          <div class="row"><span class="muted">Món quà</span><strong id="giftName">—</strong></div>
          <div class="row"><span class="muted">Mã voucher</span><span id="voucherId" class="mono">—</span></div>
          <div class="row"><span class="muted">Ngày cấp</span><span id="issuedAt">—</span></div>
          <div class="row"><span class="muted">Hạn dùng</span><span id="expiresAt">—</span></div>
          <div class="row"><span class="muted">Còn lại</span><span id="remaining">—</span></div>

          <div class="mt-6 flex flex-wrap gap-3">
            <button id="backBtn" class="btn">Quay lại đổi quà</button>
            <button id="useBtn" class="btn primary">Đánh dấu đã dùng</button>
          </div>
        </div>

        <!-- RIGHT: QR + ô chữ nhật bo góc phía dưới -->
        <div class="qr-card p-4">
          <div class="text-center">
            <div class="muted mb-2">Mã QR</div>
            <div id="qrcode" class="inline-block p-3 border rounded-lg"
                 style="background:var(--card); border-color:var(--border)"></div>
          </div>
          <!-- Ô chữ nhật bo góc dưới mã -->
          <div class="qr-note mt-4">
            Dùng ứng dụng đối tác để quét & xác thực voucher. Nhân viên có thể nhập mã thủ công nếu cần.
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="max-w-6xl mx-auto px-4 py-4 text-center text-sm muted">
      © 2025 Quiz & Assistant — Design by Mr.Hecker
    </div>
  </footer>

  <!-- Firebase compat v10 -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
  <!-- QRCode.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyDOhTKHU4P3jJ7aTkvSiewNoHu1_KXkcrU",
      authDomain: "loginandsignin-4932b.firebaseapp.com",
      projectId: "loginandsignin-4932b",
      storageBucket: "loginandsignin-4932b.appspot.com",
      messagingSenderId: "863133586719",
      appId: "1:863133586719:web:81eb32db8e08e8d89e8c2a"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();
  </script>

  <!-- ThemeManager (đồng bộ theme) -->
  <script>
  (function ThemeManagerInit(){
    var ThemeManager;
    const LS_KEY='voucher-theme', root=document.documentElement;
    let currentTheme=null, isSaving=false, saveTimer=null; const SAVE_DELAY=250;
    const getSystemPref=()=> (window.matchMedia&&window.matchMedia('(prefers-color-scheme: light)').matches)?'light':'dark';
    const hasFS = ()=> (typeof firebase!=='undefined' && typeof firebase.firestore==='function');

    function dispatchChange(theme){ try{window.dispatchEvent(new CustomEvent('themechange',{detail:{theme}}))}catch{} }
    function applyTheme(t){ currentTheme=t; t?root.setAttribute('data-theme',t):root.removeAttribute('data-theme'); dispatchChange(t); }
    function saveToLocal(t){ t?localStorage.setItem(LS_KEY,t):localStorage.removeItem(LS_KEY); }

    function waitForFb(cb){
      try{ if(firebase?.apps?.length){ cb(); return; } }catch{}
      const t=setInterval(()=>{ try{ if(firebase?.apps?.length){ clearInterval(t); cb(); } }catch{} },50);
      setTimeout(()=>clearInterval(t),10000);
    }
    async function _saveToFS(t){
      if(!hasFS()) return; const u=firebase.auth().currentUser; if(!u) return;
      await firebase.firestore().collection('users').doc(u.uid).set({ prefs:{ theme:t, updatedAt: firebase.firestore.FieldValue.serverTimestamp() } }, { merge:true });
    }
    function saveFS(t){
      if(isSaving) return; clearTimeout(saveTimer);
      saveTimer=setTimeout(async()=>{ try{ isSaving=true; await _saveToFS(t);}catch(e){console.warn('[TM] save fail:',e)}finally{isSaving=false} }, SAVE_DELAY);
    }

    (function(){ const ls=localStorage.getItem(LS_KEY); applyTheme(ls||getSystemPref()); })();

    let mql=null;
    function attachSys(){
      if(!window.matchMedia) return;
      mql=window.matchMedia('(prefers-color-scheme: light)');
      const onC=()=>{ const u=(firebase?.auth?.().currentUser); if(u) return; const sys=getSystemPref(); applyTheme(sys); saveToLocal(sys); };
      try{ mql.addEventListener?mql.addEventListener('change',onC):mql.addListener(onC);}catch{}
    }
    function detachSys(){
      if(!mql) return;
      try{ mql.removeEventListener?mql.removeEventListener('change',()=>{}):mql.removeListener(()=>{});}catch{}
      mql=null;
    }
    attachSys();

    function bindToggle(){
      const b=document.getElementById('themeBtn');
      if(!b || b.__tmBound) return;
      b.__tmBound=true;
      b.addEventListener('click', ()=> window.ThemeManager?.toggle());
    }
    bindToggle();
    const mo=new MutationObserver(()=>bindToggle());
    mo.observe(document.documentElement,{childList:true,subtree:true});

    if(!document.getElementById('themeBtn')){
      const auto=document.createElement('button');
      auto.id='themeBtn'; auto.title='Đổi giao diện';
      auto.className='btn';
      auto.innerHTML='<img id="themeIcon" src="assets/theme-light.svg" class="icon" alt="theme">';
      auto.style.cssText='position:fixed;right:12px;bottom:12px;border:1px solid var(--border);background:var(--card);color:var(--text);border-radius:12px;padding:8px 12px;z-index:9999;box-shadow:0 6px 18px rgba(0,0,0,.15);';
      document.body.appendChild(auto); bindToggle();
    }

    waitForFb(()=>{
      try{
        firebase.auth().onAuthStateChanged(async u=>{
          if(!u){ attachSys(); const ls=localStorage.getItem(LS_KEY); applyTheme(ls||getSystemPref()); return; }
          detachSys();
          const now=document.documentElement.getAttribute('data-theme')||getSystemPref();
          applyTheme(now); saveToLocal(now); saveFS(now);
        });
      }catch(e){ console.warn('[TM] auth watcher error:', e); }
    });

    window.addEventListener('storage', e=>{
      if(e.key!==LS_KEY) return;
      const next=e.newValue || getSystemPref();
      if(next!==currentTheme) applyTheme(next);
    });

    ThemeManager = {
      getTheme(){ return currentTheme || document.documentElement.getAttribute('data-theme') || getSystemPref(); },
      async setTheme(t){ if(t!=='light'&&t!=='dark') return; applyTheme(t); saveToLocal(t); if(hasFS() && firebase.auth().currentUser) saveFS(t); },
      async toggle(){ const cur=this.getTheme(); const next=(cur==='dark'?'light':'dark'); await this.setTheme(next); }
    };
    try{ window.ThemeManager = ThemeManager; }catch{}
  })();
  </script>

  <!-- Đồng bộ icon nút + favicon theo theme (nghe sự kiện themechange) -->
  <script>
    const faviconEl = document.getElementById('favicon');
    const themeIcon = document.getElementById('themeIcon');

    function applyThemeAssets(mode){
      if (themeIcon) {
        themeIcon.src = mode === 'dark' ? 'assets/theme-dark.svg' : 'assets/theme-light.svg';
        themeIcon.alt = mode === 'dark' ? 'Dark' : 'Light';
      }
      if (faviconEl) {
        faviconEl.href = mode === 'dark' ? 'assets/favicon-dark.svg' : 'assets/favicon-light.svg';
        // ép Chrome refresh favicon
        const bust='?v='+Date.now();
        faviconEl.href = faviconEl.href.split('?')[0] + bust;
      }

      // Đổi màu QR khi theme đổi (render lại)
      if (window.__lastVoucherId) {
        renderQRCode(window.__lastVoucherId);
      }
    }

    // Lần đầu
    (function initIcons(){
      const mode = (window.ThemeManager?.getTheme && window.ThemeManager.getTheme()) || 'dark';
      applyThemeAssets(mode);
    })();

    // Cập nhật khi theme đổi
    window.addEventListener('themechange', (e)=>{
      const mode = e?.detail?.theme || 'dark';
      applyThemeAssets(mode);
    });
  </script>

  <!-- Voucher + QR logic -->
  <script>
    const qs    = new URLSearchParams(location.search);
    const idQ   = qs.get('id');
    const $     = (id)=> document.getElementById(id);

    const giftNameEl = $('giftName');
    const voucherIdEl= $('voucherId');
    const issuedAtEl = $('issuedAt');
    const expiresAtEl= $('expiresAt');
    const remainingEl= $('remaining');
    const statusBadge= $('statusBadge');
    const backBtn    = $('backBtn');
    const useBtn     = $('useBtn');

    backBtn.onclick = ()=> location.href='redeem.html';

    // đếm ngược
    let timer = null;
    function startCountdown(expireMs){
      function tick(){
        const now = Date.now();
        let diff = expireMs - now;
        if (diff <= 0){
          remainingEl.textContent = 'Đã hết hạn';
          clearInterval(timer); timer = null;
          return;
        }
        const d = Math.floor(diff / (24*60*60*1000)); diff %= 24*60*60*1000;
        const h = Math.floor(diff / (60*60*1000));    diff %= 60*60*1000;
        const m = Math.floor(diff / (60*1000));       diff %= 60*1000;
        const s = Math.floor(diff / 1000);
        remainingEl.textContent = `${d} ngày ${h} giờ ${m} phút ${s} giây`;
      }
      tick();
      timer = setInterval(tick, 1000);
    }

    function setStatusBadge(status){
      statusBadge.classList.remove('active','expired','used');
      statusBadge.textContent = status;
      statusBadge.classList.add(status);
    }

    async function loadVoucherDoc(uid){
      if (idQ){
        const doc = await db.collection('vouchers').doc(idQ).get();
        if (doc.exists) return { id: idQ, data: doc.data() };
      }
      const u = await db.collection('users').doc(uid).get();
      const vid = u.exists ? (u.data().last_voucher_id || null) : null;
      if (!vid) return null;
      const doc = await db.collection('vouchers').doc(vid).get();
      if (!doc.exists) return null;
      return { id: vid, data: doc.data() };
    }

    // Bổ sung expiresAt nếu DB cũ chưa có (dựa vào issuedAt + validDays)
    async function ensureExpiresField(vId, data){
      if (data.expiresAt) return data;
      const validDays = Number(data.validDays || 7);
      const issued = data.issuedAt && data.issuedAt.toDate ? data.issuedAt.toDate().getTime() : Date.now();
      const expMs = issued + validDays*24*60*60*1000;
      const expiresAt = firebase.firestore.Timestamp.fromDate(new Date(expMs));
      await db.collection('vouchers').doc(vId).set({ expiresAt }, { merge: true });
      return { ...data, expiresAt };
    }

    // Nếu đã quá hạn mà status vẫn active -> chuyển expired
    async function ensureStatusUpToDate(vId, data){
      const exp = data.expiresAt && data.expiresAt.toDate ? data.expiresAt.toDate().getTime() : null;
      if (!exp) return data;
      if (Date.now() > exp && data.status === 'active'){
        await db.collection('vouchers').doc(vId).set({ status: 'expired' }, { merge: true });
        return { ...data, status: 'expired' };
      }
      return data;
    }

    // ===== QR code =====
    function renderQRCode(voucherCode){
      const qrEl = document.getElementById('qrcode');
      if (!qrEl) return;
      qrEl.innerHTML = '';
      // Lấy màu hiện tại từ CSS variables để khớp theme
      const styles = getComputedStyle(document.documentElement);
      const colorDark  = styles.getPropertyValue('--text').trim() || '#000000';
      const colorLight = styles.getPropertyValue('--card').trim() || '#ffffff';

      new QRCode(qrEl, {
        text: voucherCode,
        width: 180,
        height: 180,
        colorDark: colorDark,
        colorLight: colorLight,
        correctLevel: QRCode.CorrectLevel.H
      });
    }

    // Nút "đã dùng"
    useBtn.onclick = async ()=>{
      try{
        const id = idQ || voucherIdEl.textContent;
        if(!id) return;
        await db.collection('vouchers').doc(id).set({ status: 'used' }, { merge: true });
        setStatusBadge('used');
      }catch(e){ alert('Không thể cập nhật trạng thái: '+e.message); }
    };

    // Load voucher
    auth.onAuthStateChanged(async user=>{
      if(!user){ location.href='login.html'; return; }
      try{
        const res = await loadVoucherDoc(user.uid);
        if(!res){ alert('Không tìm thấy voucher.'); return; }

        const { id, data } = res;
        const d1 = await ensureExpiresField(id, data);
        const d2 = await ensureStatusUpToDate(id, d1);

        const giftName = d2.giftName || '—';
        const issued   = d2.issuedAt && d2.issuedAt.toDate ? d2.issuedAt.toDate() : null;
        const expires  = d2.expiresAt && d2.expiresAt.toDate ? d2.expiresAt.toDate() : null;
        const status   = d2.status || 'active';

        giftNameEl.textContent = giftName;
        voucherIdEl.textContent= id;
        issuedAtEl.textContent = issued ? issued.toLocaleString('vi-VN') : '—';
        expiresAtEl.textContent= expires ? expires.toLocaleString('vi-VN') : '—';
        setStatusBadge(status);

        // Lưu id để re-render QR khi đổi theme
        window.__lastVoucherId = id;
        renderQRCode(id);

        if (expires) startCountdown(expires.getTime());
        else remainingEl.textContent = '—';
      }catch(e){
        console.error(e);
        alert('Lỗi tải voucher: '+e.message);
      }
    });
  </script>
</body>
</html>
