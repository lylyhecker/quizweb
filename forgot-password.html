<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quên Mật Khẩu</title>

  <!-- Favicon SVG -->
  <link id="favicon" rel="icon" type="image/svg+xml" href="assets/favicon-light.svg">

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{ --bg:#0b1020; --bg-soft:#11162a; --card:#121a33; --text:#e7ecf7; --muted:#a8b2d1; --primary:#7aa2ff; --primary-strong:#5a86ff; --ok:#22c55e; --err:#ef4444; --border:rgba(255,255,255,.08); --shadow:0 10px 30px rgba(0,0,0,.25); }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f8fa; --bg-soft:#eef1f6; --card:#ffffff; --text:#111827; --muted:#6b7280; --primary:#2563eb; --primary-strong:#1e40af; --ok:#16a34a; --err:#dc2626; --border:rgba(0,0,0,.08); --shadow:0 10px 30px rgba(0,0,0,.08); }
    }
    :root[data-theme="light"]{ --bg:#f6f8fa; --bg-soft:#eef1f6; --card:#ffffff; --text:#111827; --muted:#6b7280; --primary:#2563eb; --primary-strong:#1e40af; --ok:#16a34a; --err:#dc2626; --border:rgba(0,0,0,.08); --shadow:0 10px 30px rgba(0,0,0,.08); }
    :root[data-theme="dark"]{ --bg:#0b1020; --bg-soft:#11162a; --card:#121a33; --text:#e7ecf7; --muted:#a8b2d1; --primary:#7aa2ff; --primary-strong:#5a86ff; --ok:#22c55e; --err:#ef4444; --border:rgba(255,255,255,.08); --shadow:0 10px 30px rgba(0,0,0,.25); }

    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif,system-ui;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(122,162,255,.18), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(125,211,252,.16), transparent 60%),
        var(--bg);
    }
    .card{ background:var(--card); color:var(--text); border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow); }
    .btn{ appearance:none; border:none; cursor:pointer; background:var(--primary); color:#fff; font-weight:700; padding:10px 14px; border-radius:12px; transition:transform .12s ease, background .2s ease; box-shadow:0 6px 18px rgba(37,99,235,.25); display:inline-flex; align-items:center; gap:8px; justify-content:center; width:100%; }
    .btn:hover{ transform:translateY(-1px); background:var(--primary-strong); }
    .btn.secondary{ background:transparent; color:var(--text); border:1px solid var(--border); box-shadow:none; width:auto; }
    .btn.secondary:hover{ background:var(--bg-soft); }
    .input{ width:100%; padding:10px 12px; border-radius:12px; background:var(--card); color:var(--text); border:1px solid var(--border); outline:none; }
    .muted{ color:var(--muted); }
    .topbar{ display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
    .logo{ width:36px; height:36px; border-radius:12px; display:grid; place-items:center; background:linear-gradient(135deg,var(--primary),#60a5fa); box-shadow:var(--shadow); }
    .icon{width:18px;height:18px;object-fit:contain;display:inline-block}
  </style>
</head>
<body>
  <main class="max-w-md mx-auto p-5 min-h-screen flex items-center">
    <div class="w-full">
      <div class="topbar">
        <div class="flex items-center gap-3">
          <div class="logo">
            <img src="assets/forgotps.svg" class="icon" alt="lock">
          </div>
          <div>
            <h1 class="text-lg font-extrabold">Đặt lại mật khẩu</h1>
            <div class="text-xs muted" id="status">Nhập email để nhận liên kết</div>
          </div>
        </div>
        <button class="btn secondary" id="themeBtn" title="Đổi giao diện">
          <img id="themeIcon" src="assets/theme-light.svg" class="icon" alt="theme">
        </button>
      </div>

      <section class="card p-5">
        <form id="forgot-password-form" class="space-y-4">
          <div>
            <label class="text-sm muted block mb-1">
              <img src="assets/email.svg" class="icon" alt="email"> Email
            </label>
            <input id="email" type="email" required class="input">
          </div>

          <!-- Nếu tương lai bạn thêm ô username, validator bên dưới sẽ tự áp dụng:
               <input name="username" class="input" placeholder="Tên đăng nhập (ASCII)" />
          -->

          <button id="reset-btn" type="submit" class="btn">
            <img src="assets/send.svg" class="icon" alt="send"> Gửi liên kết đặt lại
          </button>
        </form>

        <p class="mt-4 text-center">
          <a class="btn secondary" href="login.html">
            <img src="assets/back.svg" class="icon" alt="back"> Quay lại đăng nhập
          </a>
        </p>
      </section>
    </div>
  </main>

  <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="card w-full max-w-sm mx-auto mt-28 p-6 text-center">
      <i id="notification-icon" class="text-5xl mb-4"></i>
      <h2 id="notification-title" class="text-xl font-semibold mb-3"></h2>
      <p id="notification-message" class="muted mb-5"></p>
      <button onclick="closeModal('notification-modal')" class="btn">Đóng</button>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>

  <!-- Theme Manager -->
  <script>
    (function(){
      var ThemeManager;
      const LS_KEY='voucher-theme', root=document.documentElement;
      let currentTheme=null;
      const getSystemPref=()=> (window.matchMedia&&window.matchMedia('(prefers-color-scheme: light)').matches)?'light':'dark';
      function dispatchChange(theme){window.dispatchEvent(new CustomEvent('themechange',{detail:{theme}}))}
      function applyTheme(t){ currentTheme=t; root.setAttribute('data-theme',t); dispatchChange(t);}
      function saveToLocal(t){ localStorage.setItem(LS_KEY,t);}
      (function(){ const ls=localStorage.getItem(LS_KEY); applyTheme(ls||getSystemPref()); })();
      document.getElementById('themeBtn')?.addEventListener('click', ()=> ThemeManager?.toggle());
      ThemeManager = { getTheme(){return currentTheme||root.getAttribute('data-theme')||getSystemPref();}, setTheme(t){applyTheme(t);saveToLocal(t);}, toggle(){this.setTheme(this.getTheme()==='dark'?'light':'dark');} };
      window.ThemeManager = ThemeManager;
      function applyAssets(mode){
        document.getElementById('themeIcon').src = mode==='dark'?'assets/theme-dark.svg':'assets/theme-light.svg';
        const fav=document.getElementById('favicon'); fav.href = mode==='dark'?'assets/favicon-dark.svg':'assets/favicon-light.svg';
        fav.href = fav.href.split('?')[0] + '?v=' + Date.now();
      }
      applyAssets(ThemeManager.getTheme());
      window.addEventListener('themechange', e=>applyAssets(e.detail.theme));
    })();
  </script>

  <script>
    const firebaseConfig={apiKey:"AIzaSyDOhTKHU4P3jJ7aTkvSiewNoHu1_KXkcrU",authDomain:"loginandsignin-4932b.firebaseapp.com",projectId:"loginandsignin-4932b",storageBucket:"loginandsignin-4932b.appspot.com",messagingSenderId:"863133586719",appId:"1:863133586719:web:81eb32db8e08e8d89e8c2a"};
    firebase.initializeApp(firebaseConfig);
    const auth=firebase.auth();

    function showNotification(title,msg,type='success'){
      const m=document.getElementById('notification-modal');
      document.getElementById('notification-title').textContent=title;
      document.getElementById('notification-message').textContent=msg;
      document.getElementById('notification-icon').className=`text-5xl mb-4 ${type==='success'?'fas fa-check-circle text-green-500':'fas fa-exclamation-circle text-red-500'}`;
      m.classList.remove('hidden');
    }
    function closeModal(id){document.getElementById(id).classList.add('hidden');}

    document.getElementById('forgot-password-form').addEventListener('submit', async e=>{
      e.preventDefault();
      const btn=document.getElementById('reset-btn'); btn.disabled=true; btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';
      const email=document.getElementById('email').value;
      try{
        await auth.sendPasswordResetEmail(email);
        showNotification('Thành công!','Liên kết đặt lại mật khẩu đã được gửi tới '+email,'success');
        setTimeout(()=>location.href='login.html',2000);
      }catch(error){
        showNotification('Lỗi', error.code==='auth/user-not-found'?'Email này chưa được đăng ký.':'Gửi liên kết thất bại: '+error.message,'error');
      }finally{
        btn.disabled=false; btn.innerHTML='<img src="assets/send.svg" class="icon" alt="send"> Gửi liên kết đặt lại';
      }
    });
  </script>

  <!-- ===== Username Validator (chặn Unicode, chỉ ASCII) ===== -->
  <script>
    (function UsernameValidatorInit(){
      // Regex chặn Unicode (chỉ ASCII in được)
      const NO_UNICODE_RE = /^[\x20-\x7E]+$/;
      // Quy tắc: 2–30, chỉ A-Z a-z 0-9 . _ -, không bắt đầu/kết thúc bằng . _ -, không có .. __ --
      const USERNAME_ASCII_RE = /^(?!.*\.\.)(?!.*__)(?!.*--)[A-Za-z0-9](?:[A-Za-z0-9._-]{0,28}[A-Za-z0-9])$/;

      function validateUsernameValue(val){
        const s = (val||"").trim();
        if(!NO_UNICODE_RE.test(s)) {
          return { ok:false, msg:"Chỉ cho phép ASCII, không ký tự Unicode." };
        }
        if(!USERNAME_ASCII_RE.test(s)) {
          return { ok:false, msg:"2–30 ký tự: A–Z a–z 0–9 . _ -, không đầu/cuối bằng . _ -, không có .. __ --" };
        }
        return { ok:true, msg:"" };
      }

      // Áp dụng tự động cho mọi input name="username" hoặc có data-username
      function attach(el){
        if(!el || el._usernameValidatorBound) return;
        el._usernameValidatorBound = true;

        el.setAttribute("autocomplete","username");
        el.setAttribute("spellcheck","false");
        el.setAttribute("autocapitalize","off");
        el.setAttribute("minlength","2");
        el.setAttribute("maxlength","30");

        el.addEventListener("input", () => {
          const {ok, msg} = validateUsernameValue(el.value);
          el.setCustomValidity(ok ? "" : msg);
          el.reportValidity();
        });

        el.form?.addEventListener("submit", (e) => {
          const {ok, msg} = validateUsernameValue(el.value);
          if(!ok){
            e.preventDefault();
            el.setCustomValidity(msg);
            el.reportValidity();
            el.focus();
          } else {
            el.setCustomValidity("");
          }
        });
      }

      // Tìm sẵn trên trang
      document.querySelectorAll('input[name="username"], [data-username]').forEach(attach);

      // Quan sát DOM để auto-attach nếu input được thêm sau
      const obs = new MutationObserver((mutations)=>{
        mutations.forEach(m=>{
          m.addedNodes.forEach(node=>{
            if(!(node instanceof Element)) return;
            if(node.matches?.('input[name="username"], [data-username]')) attach(node);
            node.querySelectorAll?.('input[name="username"], [data-username]').forEach(attach);
          });
        });
      });
      obs.observe(document.documentElement, {childList:true, subtree:true});

      // Expose tiện cho tái sử dụng
      window.UsernameValidator = {
        validateRaw: (val)=> validateUsernameValue(val),
        regex: { NO_UNICODE_RE, USERNAME_ASCII_RE },
        attach
      };
    })();
  </script>
</body>
</html>
